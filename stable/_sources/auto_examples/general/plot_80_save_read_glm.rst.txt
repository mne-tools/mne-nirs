
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "auto_examples/general/plot_80_save_read_glm.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        :ref:`Go to the end <sphx_glr_download_auto_examples_general_plot_80_save_read_glm.py>`
        to download the full example code or to run this example in your browser via Binder

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_auto_examples_general_plot_80_save_read_glm.py:


.. _tut-glm-save:

Save and load GLM results
=========================

This is an example of how to save and load
functional near-infrared spectroscopy (fNIRS)
GLM results from analysis in MNE-NIRS.
As computation can be expensive and time consuming it can be useful
to store computed results to disk, so that you can query the results later.
For example, to remake a figure or answer a new scientific question.

For a description of the analysis in this tutorial see the
:ref:`MNE-NIRS individual GLM tutorial <tut-fnirs-hrf>` and
:ref:`MNE-NIRS group GLM tutorial <tut-fnirs-group>`.
This tutorial will simply focus on saving and loading data.

The data used in this example is available
`at this location <https://github.com/rob-luke/BIDS-NIRS-Tapping>`_.
It is a finger tapping example and is briefly described below.
The dataset contains 5 participants.
The example dataset is in
`BIDS <https://bids.neuroimaging.io>`_
format and therefore already contains
information about triggers, condition names, etc.

.. note::

   This tutorial uses data stored using
   `the BIDS format <https://bids-specification.readthedocs.io/en/stable/04-modality-specific-files/11-near-infrared-spectroscopy.html>`_
   :footcite:p:`luke2023bids`.

   MNE-Python allows you to process fNIRS data that is not in BIDS format.
   Simply modify the ``read_raw_`` function to match your data type.
   See :ref:`data importing tutorial <tut-importing-fnirs-data>` to learn how
   to use your data with MNE-Python.

.. contents:: Page contents
   :local:
   :depth: 2

.. GENERATED FROM PYTHON SOURCE LINES 43-64

.. code-block:: Python

    # Authors: Robert Luke <mail@robertluke.net>
    #
    # License: BSD (3-clause)

    # Import common libraries
    from os.path import join
    import pandas as pd

    # Import MNE functions
    from mne.preprocessing.nirs import optical_density, beer_lambert_law

    # Import MNE-NIRS functions
    from mne_nirs.statistics import run_glm
    from mne_nirs.experimental_design import make_first_level_design_matrix
    from mne_nirs.statistics import read_glm
    from mne_nirs.datasets import fnirs_motor_group

    # Import MNE-BIDS processing
    from mne_bids import BIDSPath, read_raw_bids, get_entity_vals









.. GENERATED FROM PYTHON SOURCE LINES 65-74

Set up directories
------------------

First we will define where the raw data is stored. We will analyse a
BIDS dataset, note that the BIDS specification for NIRS data is still
under development and you will need to install the development branch
as described above.

We first define the root directory of our dataset.

.. GENERATED FROM PYTHON SOURCE LINES 74-79

.. code-block:: Python


    root = fnirs_motor_group.data_path()
    print(root)






.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    /home/circleci/mne_data/fNIRS-motor-group




.. GENERATED FROM PYTHON SOURCE LINES 80-82

And as we are using MNE-BIDS we can create a BIDSPath.
This helps to handle all the path wrangling.

.. GENERATED FROM PYTHON SOURCE LINES 82-87

.. code-block:: Python


    dataset = BIDSPath(root=root, task="tapping")
    print(dataset.directory)






.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    /home/circleci/mne_data/fNIRS-motor-group




.. GENERATED FROM PYTHON SOURCE LINES 88-89

For example we can automatically query the subjects, tasks, and sessions.

.. GENERATED FROM PYTHON SOURCE LINES 89-94

.. code-block:: Python


    subjects = get_entity_vals(root, 'subject')
    print(subjects)






.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    ['01', '02', '03', '04', '05']




.. GENERATED FROM PYTHON SOURCE LINES 95-96

But for this example we will only process the first two subjects

.. GENERATED FROM PYTHON SOURCE LINES 96-99

.. code-block:: Python

    subjects = subjects[:2]









.. GENERATED FROM PYTHON SOURCE LINES 100-107

Define individual analysis
--------------------------

First we define the analysis that will be applied to each file.
This is a GLM analysis as described in the
:ref:`individual GLM tutorial <tut-fnirs-hrf>`,
so this example will skim over the individual level details.

.. GENERATED FROM PYTHON SOURCE LINES 107-122

.. code-block:: Python



    def individual_analysis(bids_path):

        raw_intensity = read_raw_bids(bids_path=bids_path, verbose=False)
        # Delete annotation labeled 15, as these just signify the start and end of experiment.
        raw_intensity.annotations.delete(raw_intensity.annotations.description == '15.0')
        raw_intensity.pick(picks=range(20)).crop(200).resample(0.3)  # Reduce load
        raw_haemo = beer_lambert_law(optical_density(raw_intensity), ppf=0.1)
        design_matrix = make_first_level_design_matrix(raw_haemo)
        glm_est = run_glm(raw_haemo, design_matrix)

        return glm_est









.. GENERATED FROM PYTHON SOURCE LINES 123-128

Run analysis and save to disk
-----------------------------

Next we loop through the five measurements and run the individual analysis
on each. We will then save the GLM results to disk as ``.h5`` files.

.. GENERATED FROM PYTHON SOURCE LINES 128-155

.. code-block:: Python



    for sub in subjects:

        # Create path to file based on experiment info
        data_path = dataset.update(subject=sub,
                                   datatype="nirs",
                                   suffix="nirs",
                                   extension=".snirf")

        # Analyse data and glm results
        glm = individual_analysis(data_path)

        # Next we create a location to store the results.
        # In BIDS fashion we will store this in a subdirectory called derivatives.
        # And we can use the BIDSPath type from above to handle the path details.

        save_path = dataset.copy().update(
            root=join(root, "derivatives"),
            datatype="nirs", suffix="glm", extension=".h5",check=False)
        # Ensure the folder exists, and make it if not.
        save_path.fpath.parent.mkdir(exist_ok=True, parents=True)

        # Finally we save the results to disk as a hdf5 file
        glm.save(save_path.fpath, overwrite=True)









.. GENERATED FROM PYTHON SOURCE LINES 156-160

Reload results and extract summary statistics
---------------------------------------------

Next we loop through the five measurements and reload all the results.

.. GENERATED FROM PYTHON SOURCE LINES 160-182

.. code-block:: Python


    # Create a dataframe to store results
    df = pd.DataFrame()

    for sub in subjects:

        # Point to the correct subject
        save_path = save_path.update(subject=sub)

        # Read the data
        results = read_glm(save_path.fpath)

        # Extract results from data as dataframe
        individual_results = results.to_dataframe()

        # Indicate the subject ID
        individual_results["ID"] = sub

        # Append individual results to larger dataframe
        df = pd.concat([df, individual_results], ignore_index=True)









.. GENERATED FROM PYTHON SOURCE LINES 183-188

View the resulting dataframe
----------------------------

Finally we can view the resulting dataframe which contains data from all
subjects.

.. GENERATED FROM PYTHON SOURCE LINES 188-190

.. code-block:: Python


    df





.. raw:: html

    <div class="output_subarea output_html rendered_html output_result">
    <div>
    <style scoped>
        .dataframe tbody tr th:only-of-type {
            vertical-align: middle;
        }

        .dataframe tbody tr th {
            vertical-align: top;
        }

        .dataframe thead th {
            text-align: right;
        }
    </style>
    <table border="1" class="dataframe">
      <thead>
        <tr style="text-align: right;">
          <th>variable</th>
          <th>Condition</th>
          <th>df</th>
          <th>mse</th>
          <th>p_value</th>
          <th>se</th>
          <th>t</th>
          <th>theta</th>
          <th>Source</th>
          <th>Detector</th>
          <th>Chroma</th>
          <th>Significant</th>
          <th>ch_name</th>
          <th>ID</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <th>0</th>
          <td>Control</td>
          <td>59.0</td>
          <td>1.872860e-10</td>
          <td>5.717960e-01</td>
          <td>9.972242e-06</td>
          <td>-0.568585</td>
          <td>-0.000006</td>
          <td>1</td>
          <td>1</td>
          <td>hbo</td>
          <td>False</td>
          <td>S1_D1 hbo</td>
          <td>01</td>
        </tr>
        <tr>
          <th>1</th>
          <td>Tapping/Left</td>
          <td>59.0</td>
          <td>1.872860e-10</td>
          <td>1.013405e-08</td>
          <td>9.608094e-06</td>
          <td>6.660502</td>
          <td>0.000064</td>
          <td>1</td>
          <td>1</td>
          <td>hbo</td>
          <td>True</td>
          <td>S1_D1 hbo</td>
          <td>01</td>
        </tr>
        <tr>
          <th>2</th>
          <td>Tapping/Right</td>
          <td>59.0</td>
          <td>1.872860e-10</td>
          <td>7.118233e-14</td>
          <td>9.752480e-06</td>
          <td>9.729188</td>
          <td>0.000095</td>
          <td>1</td>
          <td>1</td>
          <td>hbo</td>
          <td>True</td>
          <td>S1_D1 hbo</td>
          <td>01</td>
        </tr>
        <tr>
          <th>3</th>
          <td>constant</td>
          <td>59.0</td>
          <td>1.872860e-10</td>
          <td>1.855546e-01</td>
          <td>9.631380e-07</td>
          <td>-1.339471</td>
          <td>-0.000001</td>
          <td>1</td>
          <td>1</td>
          <td>hbo</td>
          <td>False</td>
          <td>S1_D1 hbo</td>
          <td>01</td>
        </tr>
        <tr>
          <th>4</th>
          <td>drift_1</td>
          <td>59.0</td>
          <td>1.872860e-10</td>
          <td>6.643284e-11</td>
          <td>2.730230e-05</td>
          <td>7.950188</td>
          <td>0.000217</td>
          <td>1</td>
          <td>1</td>
          <td>hbo</td>
          <td>True</td>
          <td>S1_D1 hbo</td>
          <td>01</td>
        </tr>
        <tr>
          <th>...</th>
          <td>...</td>
          <td>...</td>
          <td>...</td>
          <td>...</td>
          <td>...</td>
          <td>...</td>
          <td>...</td>
          <td>...</td>
          <td>...</td>
          <td>...</td>
          <td>...</td>
          <td>...</td>
          <td>...</td>
        </tr>
        <tr>
          <th>2135</th>
          <td>drift_5</td>
          <td>48.0</td>
          <td>1.819120e-11</td>
          <td>4.253409e-01</td>
          <td>5.688788e-06</td>
          <td>-0.804035</td>
          <td>-0.000005</td>
          <td>3</td>
          <td>3</td>
          <td>hbr</td>
          <td>False</td>
          <td>S3_D3 hbr</td>
          <td>02</td>
        </tr>
        <tr>
          <th>2136</th>
          <td>drift_6</td>
          <td>48.0</td>
          <td>1.819120e-11</td>
          <td>4.021019e-03</td>
          <td>5.685045e-06</td>
          <td>3.021884</td>
          <td>0.000017</td>
          <td>3</td>
          <td>3</td>
          <td>hbr</td>
          <td>True</td>
          <td>S3_D3 hbr</td>
          <td>02</td>
        </tr>
        <tr>
          <th>2137</th>
          <td>drift_7</td>
          <td>48.0</td>
          <td>1.819120e-11</td>
          <td>8.224216e-04</td>
          <td>5.694861e-06</td>
          <td>-3.570288</td>
          <td>-0.000020</td>
          <td>3</td>
          <td>3</td>
          <td>hbr</td>
          <td>True</td>
          <td>S3_D3 hbr</td>
          <td>02</td>
        </tr>
        <tr>
          <th>2138</th>
          <td>drift_8</td>
          <td>48.0</td>
          <td>1.819120e-11</td>
          <td>2.788908e-02</td>
          <td>5.683923e-06</td>
          <td>-2.267672</td>
          <td>-0.000013</td>
          <td>3</td>
          <td>3</td>
          <td>hbr</td>
          <td>True</td>
          <td>S3_D3 hbr</td>
          <td>02</td>
        </tr>
        <tr>
          <th>2139</th>
          <td>drift_9</td>
          <td>48.0</td>
          <td>1.819120e-11</td>
          <td>1.271330e-04</td>
          <td>5.686768e-06</td>
          <td>4.169065</td>
          <td>0.000024</td>
          <td>3</td>
          <td>3</td>
          <td>hbr</td>
          <td>True</td>
          <td>S3_D3 hbr</td>
          <td>02</td>
        </tr>
      </tbody>
    </table>
    <p>2140 rows × 13 columns</p>
    </div>
    </div>
    <br />
    <br />


.. rst-class:: sphx-glr-timing

   **Total running time of the script:** (0 minutes 12.364 seconds)

**Estimated memory usage:**  16 MB


.. _sphx_glr_download_auto_examples_general_plot_80_save_read_glm.py:

.. only:: html

  .. container:: sphx-glr-footer sphx-glr-footer-example

    .. container:: binder-badge

      .. image:: images/binder_badge_logo.svg
        :target: https://mybinder.org/v2/gh/mne-tools/mne-nirs/gh-pages?filepath=stable/notebooks/auto_examples/general/plot_80_save_read_glm.ipynb
        :alt: Launch binder
        :width: 150 px

    .. container:: sphx-glr-download sphx-glr-download-jupyter

      :download:`Download Jupyter notebook: plot_80_save_read_glm.ipynb <plot_80_save_read_glm.ipynb>`

    .. container:: sphx-glr-download sphx-glr-download-python

      :download:`Download Python source code: plot_80_save_read_glm.py <plot_80_save_read_glm.py>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
