
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "auto_examples/general/plot_40_mayer.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        :ref:`Go to the end <sphx_glr_download_auto_examples_general_plot_40_mayer.py>`
        to download the full example code or to run this example in your browser via Binder

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_auto_examples_general_plot_40_mayer.py:


.. _tut-mayer:

Mayer Wave Parametrisation
==========================

.. sidebar:: Cite the FOOOF authors

   This tutorial is only possible due to the excellent and generous work of
   the FOOOF authors. Please visit their site https://fooof-tools.github.io/fooof.
   Also be sure to cite their various papers:

   Donoghue, Thomas, et al. "Parameterizing neural power spectra into periodic and aperiodic components." Nature neuroscience 23.12 (2020): 1655-1665.

   Donoghue, Thomas, Julio Dominguez, and Bradley Voytek. "Electrophysiological frequency band ratio measures conflate periodic and aperiodic neural activity." Eneuro 7.6 (2020).

Mayer waves are spontaneous oscillations in arterial blood pressure with a
frequency of ~0.1 Hz (Ghali and Ghali, 2020; Julien, 2006; Yucel, 2016).
Mayer waves are not easily removed from hemodynamic signatures of brain
activity as they tend to occur on a time course often confounded with
the frequency of a sensory task, for example, and/or the
cortical hemodynamic response to that task.

This example demonstrates how to use the
Fitting Oscillations & One Over F (FOOOF)
:footcite:`donoghue2020parameterizing`
method to quanitfy Mayer wave parameters in fNIRS data.
This is based on the description provided in
:footcite:`luke2021characterization`.

This tutorial is heavily based on the tutorials provided by the FOOOF
authors over at https://fooof-tools.github.io/fooof.
You should read their excellent documentation. Their work should be considered
the primary resource, and this is just an example of how to apply it to fNIRS
data for the purpose of extracting Mayer waves oscillation parameters.


.. contents:: Page contents
   :local:
   :depth: 2

.. GENERATED FROM PYTHON SOURCE LINES 43-61

.. code-block:: default


    # Authors: Robert Luke <mail@robertluke.net>
    #
    # License: BSD (3-clause)

    import os
    import mne
    import numpy as np
    import matplotlib.pyplot as plt

    from mne.preprocessing.nirs import optical_density, beer_lambert_law

    from mne_nirs.channels import get_long_channels
    from mne_nirs.preprocessing import quantify_mayer_fooof

    from fooof import FOOOF









.. GENERATED FROM PYTHON SOURCE LINES 62-66

Import and preprocess data
--------------------------

We read in the data and convert to haemoglobin concentration.

.. GENERATED FROM PYTHON SOURCE LINES 66-79

.. code-block:: default


    fnirs_data_folder = mne.datasets.fnirs_motor.data_path()
    fnirs_raw_dir = os.path.join(fnirs_data_folder, 'Participant-1')
    raw = mne.io.read_raw_nirx(fnirs_raw_dir, verbose=True).load_data()

    raw = optical_density(raw)
    raw.resample(2)
    raw = beer_lambert_law(raw, ppf=0.1)
    raw = raw.pick(picks="hbo")
    raw = get_long_channels(raw, min_dist=0.025, max_dist=0.045)
    raw






.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Loading /home/circleci/mne_data/MNE-fNIRS-motor-data/Participant-1


.. raw:: html

    <div class="output_subarea output_html rendered_html output_result">
    <table class="table table-hover table-striped table-sm table-responsive small">
        <tr>
            <th>Measurement date</th>
        
            <td>November 02, 2019  13:16:16 GMT</td>
        
        </tr>
        <tr>
            <th>Experimenter</th>
        
            <td>Unknown</td>
        
        </tr>
            <th>Participant</th>
        
            
                <td>P1</td>
            
        
        </tr>
        <tr>
            <th>Digitized points</th>
        
            <td>31 points</td>
        
        </tr>
        <tr>
            <th>Good channels</th>
            <td>20 Oxyhemoglobin</td>
        </tr>
        <tr>
            <th>Bad channels</th>
            <td>None</td>
        </tr>
        <tr>
            <th>EOG channels</th>
            <td>Not available</td>
        </tr>
        <tr>
            <th>ECG channels</th>
            <td>Not available</td>
    
        <tr>
            <th>Sampling frequency</th>
            <td>2.00 Hz</td>
        </tr>
    
    
        <tr>
            <th>Highpass</th>
            <td>0.00 Hz</td>
        </tr>
    
    
        <tr>
            <th>Lowpass</th>
            <td>1.00 Hz</td>
        </tr>
    
    
    
        <tr>
            <th>Filenames</th>
            <td>Participant-1</td>
        </tr>
    
        <tr>
            <th>Duration</th>
            <td>00:49:34 (HH:MM:SS)</td>
        </tr>
    </table>
    </div>
    <br />
    <br />

.. GENERATED FROM PYTHON SOURCE LINES 80-100

Process data with FOOOF
-----------------------

Next we estimate the power spectral density of the data and pass this to
the FOOOF algorithm.

I recommend using the FOOOF algorithm as provided by the authors rather
than reimplementation or custom plotting etc. Their code is of excellent
quality, well maintained, thoroughly documented, and they have considered
many edge cases.

Below we plot the spectrum of the data, the FOOOF fit of oscillations,
and aperiodic component. Note the bump at 0.1 Hz that reflects the Mayer
wave activity.

Note that the activity is not a perfect peak at 0.1 Hz, but is spread
across neighbouring frequencies. Additionally, the peak does not occur
at exactly 0.1 Hz, but instead seems to peak at approximately 0.09 Hz.
The shaded area illustrates the oscillation fitted by the FOOOF algorithm,
it matches well to the data.

.. GENERATED FROM PYTHON SOURCE LINES 100-129

.. code-block:: default


    def scale_up_spectra(spectra, freqs):
        """
        FOOOF requires the frequency values to be higher than the fNIRS data
        permits, so we scale the values up by 10 here, and then will scale
        the frequency values down by 10 later.
        """
        freqs = freqs * 10
        return spectra, freqs

    # Prepare data for FOOOF
    psd = raw.compute_psd(
        fmin=0.001, fmax=1.0, tmin=0, tmax=None, n_overlap=300, n_fft=600)
    spectra, freqs = psd.get_data(return_freqs=True)
    spectra, freqs = scale_up_spectra(spectra, freqs)

    # Specify the model, note that frequency values here are times 10
    fm = FOOOF(peak_width_limits=(0.5, 12.0))
    # Set the frequency range to fit the model, again these are times 10
    freq_range = [0.001, 7]

    fm.fit(freqs, np.mean(spectra, axis=0), freq_range)

    fig, axs = plt.subplots(1, 1, figsize=(10, 5))
    fm.plot(plot_peaks='shade', data_kwargs={'color': 'orange'}, ax=axs)
    # Correct for x10 scaling above
    plt.xticks([0, 1, 2, 3, 4, 5, 6], [0.0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6])





.. image-sg:: /auto_examples/general/images/sphx_glr_plot_40_mayer_001.png
   :alt: plot 40 mayer
   :srcset: /auto_examples/general/images/sphx_glr_plot_40_mayer_001.png
   :class: sphx-glr-single-img


.. rst-class:: sphx-glr-script-out

 .. code-block:: none


    ([<matplotlib.axis.XTick object at 0x7f9aca2fe1f0>, <matplotlib.axis.XTick object at 0x7f9aca2fe610>, <matplotlib.axis.XTick object at 0x7f9aca2fe250>, <matplotlib.axis.XTick object at 0x7f9aca2db8e0>, <matplotlib.axis.XTick object at 0x7f9a6b187df0>, <matplotlib.axis.XTick object at 0x7f99df249190>, <matplotlib.axis.XTick object at 0x7f9a6b187c40>], [Text(0, 0, '0.0'), Text(1, 0, '0.1'), Text(2, 0, '0.2'), Text(3, 0, '0.3'), Text(4, 0, '0.4'), Text(5, 0, '0.5'), Text(6, 0, '0.6')])



.. GENERATED FROM PYTHON SOURCE LINES 130-139

Use MNE-NIRS to quantify Mayer wave oscillation
-----------------------------------------------

MNE-NIRS provides a convenient function to estimate the Mayer wave
parameters that takes care of the frequency scaling and selects the component
most likely associated with the Mayer wave. It returns this data in a pandas
dataframe for your convenience.
It uses the FOOOF algorithm under the hood, so ensure you cite the original
authors if you use this function.

.. GENERATED FROM PYTHON SOURCE LINES 139-143

.. code-block:: default


    quantify_mayer_fooof(raw.pick("hbo"), extra_df_fields={"Study": "Online tutorial"})







.. raw:: html

    <div class="output_subarea output_html rendered_html output_result">
    <div>
    <style scoped>
        .dataframe tbody tr th:only-of-type {
            vertical-align: middle;
        }

        .dataframe tbody tr th {
            vertical-align: top;
        }

        .dataframe thead th {
            text-align: right;
        }
    </style>
    <table border="1" class="dataframe">
      <thead>
        <tr style="text-align: right;">
          <th></th>
          <th>Centre Frequency</th>
          <th>Bandwidth</th>
          <th>Power</th>
          <th>Chromaphore</th>
          <th>Study</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <th>0</th>
          <td>0.090168</td>
          <td>0.069643</td>
          <td>0.763865</td>
          <td>hbo</td>
          <td>Online tutorial</td>
        </tr>
      </tbody>
    </table>
    </div>
    </div>
    <br />
    <br />

.. GENERATED FROM PYTHON SOURCE LINES 144-168

Conclusion
----------

We have demonstrated how to use the FOOOF algorithm for quantifying Mayer
wave parameters, and highlighted the `quantify_mayer_fooof` for conveniently
applying this analysis to fNIRS data with MNE-NIRS.

An example measurement illustrated what the presence of a Mayer wave
looks like with a power spectral density. The measurement also illustrated that the Mayer wave
is not a perfect sinusoid, as evidenced by the broad spectral content.
Further, the example illustrated that the Mayer wave is not always precisely locked
to 0.1 Hz, both visual inspection and FOOOF quantification indicate a 0.09 Hz
centre frequency.

See the article Luke (2021) :footcite:`luke2021characterization` for further
details on this analysis approach, and normative data from over 300 fNIRS
measurements. This article also demonstrates that using short-channel
systemic component correction algorithms can reduce the Mayer wave component
in the signal (see also Yucel 2016).
See both the
:ref:`GLM tutorial <tut-fnirs-hrf>`
and
:ref:`signal enhancement tutorial <tut-fnirs-enhance>`
for how to use short channels in either a GLM or averaging analysis with MNE-NIRS.

.. GENERATED FROM PYTHON SOURCE LINES 171-175

Bibliography
-----------------------------------------------

.. footbibliography::


.. rst-class:: sphx-glr-timing

   **Total running time of the script:** ( 0 minutes  3.394 seconds)

**Estimated memory usage:**  9 MB


.. _sphx_glr_download_auto_examples_general_plot_40_mayer.py:

.. only:: html

  .. container:: sphx-glr-footer sphx-glr-footer-example


    .. container:: binder-badge

      .. image:: images/binder_badge_logo.svg
        :target: https://mybinder.org/v2/gh/mne-tools/mne-nirs/gh-pages?filepath=dev/notebooks/auto_examples/general/plot_40_mayer.ipynb
        :alt: Launch binder
        :width: 150 px

    .. container:: sphx-glr-download sphx-glr-download-python

      :download:`Download Python source code: plot_40_mayer.py <plot_40_mayer.py>`

    .. container:: sphx-glr-download sphx-glr-download-jupyter

      :download:`Download Jupyter notebook: plot_40_mayer.ipynb <plot_40_mayer.ipynb>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
